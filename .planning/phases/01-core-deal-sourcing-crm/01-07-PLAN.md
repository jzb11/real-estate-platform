---
phase: 01-core-deal-sourcing-crm
plan: "07"
type: execute
wave: 2
depends_on:
  - "01-01"
files_modified:
  - src/app/api/kb/articles/route.ts
  - src/app/api/kb/articles/[slug]/route.ts
  - src/app/api/kb/search/route.ts
  - src/app/(dashboard)/kb/page.tsx
  - src/app/(dashboard)/kb/[slug]/page.tsx
  - prisma/seed-kb.ts

autonomous: true
requirements:
  - KB-01
  - KB-02
  - KB-03
  - KB-04

must_haves:
  truths:
    - "User can browse knowledge base articles organized by category (ANALYSIS, COMPLIANCE, FORMULAS, CREATIVE_FINANCE)"
    - "User can read a full article about deal analysis (e.g., 70% rule, MAO calculation)"
    - "User can read a guide on creative finance structures (subject-to, seller financing)"
    - "User can search the knowledge base by keyword and see matching articles"
    - "Deal detail page shows a contextually relevant KB article link (e.g., 'How to calculate MAO')"
  artifacts:
    - path: "src/app/api/kb/articles/route.ts"
      provides: "GET /api/kb/articles — list articles with optional category filter"
      exports: ["GET"]
    - path: "src/app/api/kb/articles/[slug]/route.ts"
      provides: "GET /api/kb/articles/:slug — full article content + logs view"
      exports: ["GET"]
    - path: "src/app/api/kb/search/route.ts"
      provides: "GET /api/kb/search?q=... — full-text search over title + content"
      exports: ["GET"]
    - path: "src/app/(dashboard)/kb/page.tsx"
      provides: "Knowledge base index — search bar + categories + article list"
      min_lines: 50
    - path: "src/app/(dashboard)/kb/[slug]/page.tsx"
      provides: "Article reader — full content rendered from markdown"
      min_lines: 40
    - path: "prisma/seed-kb.ts"
      provides: "Seeds 6+ starter articles covering deal analysis, TCPA compliance, creative finance"
  key_links:
    - from: "src/app/(dashboard)/kb/page.tsx"
      to: "/api/kb/search"
      via: "search input calls GET /api/kb/search?q=term with debounce"
      pattern: "fetch.*api/kb/search"
    - from: "src/app/(dashboard)/kb/[slug]/page.tsx"
      to: "/api/kb/articles/[slug]"
      via: "fetches full article by slug, renders markdown with react-markdown"
      pattern: "fetch.*api/kb/articles"
---

<objective>
Implement the knowledge base: seeded starter articles, CRUD API, full-text search, and contextually integrated help within the deal dashboard.

Purpose: KB-01 through KB-04 require accessible educational content about deal analysis, creative finance structures, and compliance. This is the "zero support requests" insurance — users who understand the platform don't abandon it or make costly mistakes.

Output: A searchable knowledge base with seeded articles on deal analysis (70% rule, MAO), creative finance (subject-to, seller financing), and TCPA compliance. Search works by keyword. Articles link contextually from the deal detail page.
</objective>

<execution_context>
@/Users/jakezebe/.claude/get-shit-done/workflows/execute-plan.md
@/Users/jakezebe/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-core-deal-sourcing-crm/01-RESEARCH.md
@.planning/phases/01-core-deal-sourcing-crm/01-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Knowledge base API and seeded starter articles</name>
  <files>
    src/app/api/kb/articles/route.ts
    src/app/api/kb/articles/[slug]/route.ts
    src/app/api/kb/search/route.ts
    prisma/seed-kb.ts
  </files>
  <action>
    **1. Create `prisma/seed-kb.ts`:**
    Seed script that inserts starter articles into KbArticle table. Run with: `npx tsx prisma/seed-kb.ts`

    Create the following 7 articles (isPublished: true for all):

    Article 1 — slug: "deal-analysis-70-percent-rule"
    - title: "The 70% Rule: Your Foundation for Deal Analysis"
    - category: FORMULAS
    - content: Full markdown explanation of:
      - What the 70% rule is: MAO = (ARV × 0.70) − Repair Costs
      - Why 70% (accounts for purchase price + profit margin + closing costs)
      - Example calculation with real numbers ($200K ARV, $30K repairs → $110K MAO)
      - When to deviate from 70% (strong market vs. slow market)
      - Common mistake: using asking price as ARV instead of actual after-repair value

    Article 2 — slug: "what-is-subject-to-financing"
    - title: "Subject-To Financing: Buying Properties with Existing Mortgages"
    - category: CREATIVE_FINANCE
    - content: Markdown covering:
      - Definition: buyer takes title "subject to" the existing mortgage staying in place
      - Why sellers agree: avoid foreclosure, get out from underwater mortgage
      - Risk factors: due-on-sale clause, title transfer risks
      - Qualification criteria for subject-to deals: seller motivation + equity/no equity + payment current
      - How this platform identifies subject-to candidates (distress signals + low equity)

    Article 3 — slug: "seller-financing-guide"
    - title: "Seller Financing: How to Structure Owner-Financed Deals"
    - category: CREATIVE_FINANCE
    - content: Markdown covering:
      - Definition: seller acts as the bank, buyer makes payments to seller
      - When sellers agree: need cash flow but not lump sum, can't find buyers at full price
      - Key terms to negotiate: interest rate, amortization, balloon payment
      - Qualifying candidates: paid-off property or high equity + seller motivated to carry note
      - Sample term sheet structure

    Article 4 — slug: "tcpa-compliance-wholesalers"
    - title: "TCPA Compliance for Real Estate Wholesalers"
    - category: COMPLIANCE
    - content: Markdown covering:
      - What TCPA is and who it applies to (includes real estate wholesalers)
      - Fine structure: $500–$1,500 per violation, multiplied per contact
      - What triggers a violation: calling/texting without prior express written consent
      - How this platform protects you: consent logging, DNC list check, audit trail
      - Best practice checklist: always obtain written consent, honor opt-outs immediately, retain records 4 years

    Article 5 — slug: "reading-distress-signals"
    - title: "How to Read Property Distress Signals"
    - category: ANALYSIS
    - content: Markdown covering:
      - Foreclosure: what it means, how to find pre-foreclosure opportunities
      - Pre-foreclosure vs. auction: timing window and negotiation leverage
      - Tax delinquency: indicator of financial distress without foreclosure filing
      - Long time on market: motivation signal (seller may be open to creative terms)
      - How qualification rules use these signals (weight-based scoring)

    Article 6 — slug: "platform-quick-start"
    - title: "Quick Start: From CSV Import to Your First Qualified Deal"
    - category: ANALYSIS
    - content: Step-by-step onboarding guide:
      1. Export from PropStream (instructions on which filters to set in PropStream UI)
      2. Import CSV to this platform
      3. Review filtered property list
      4. Understand the qualification score
      5. Create a deal from a property
      6. Move through the pipeline stages
      7. Calculate your MAO before making an offer

    Article 7 — slug: "deal-pipeline-stages"
    - title: "Understanding the Deal Pipeline: From Sourced to Closed"
    - category: ANALYSIS
    - content: Guide to each pipeline stage, what it means, and when to advance:
      - SOURCED: just imported, not yet analyzed
      - ANALYZING: qualification rules running, evaluating metrics
      - QUALIFIED: rules passed, score >= 50, ready to pursue
      - UNDER_CONTRACT: offer accepted, in due diligence
      - CLOSED: deal completed
      - REJECTED: eliminated at any stage

    Use `prisma.kbArticle.upsert({ where: { slug }, create: {...}, update: {...} })` for idempotent seeding.

    **2. Create `src/app/api/kb/articles/route.ts`:**
    GET /api/kb/articles — list published articles:
    - Query params: `category` (optional, filters by KbCategory enum), `limit` (default 20), `page`
    - Only return `isPublished: true` articles
    - Return: `{ articles: [{ id, title, slug, category, viewCount, createdAt }], total }`
    - No authentication required (knowledge base is public within the app)
    - Order by viewCount DESC (popular articles first), then createdAt DESC

    **3. Create `src/app/api/kb/articles/[slug]/route.ts`:**
    GET /api/kb/articles/:slug — full article content:
    - Return full article including `content` (markdown string)
    - If authenticated (Clerk auth present): log view to KbAccessLog and increment viewCount
    - If not found or isPublished=false: return 404
    - Return: `{ id, title, slug, category, content, viewCount, createdAt, updatedAt }`

    **4. Create `src/app/api/kb/search/route.ts`:**
    GET /api/kb/search?q=... — keyword search:
    - Query param `q`: search term (min 2 chars, return 400 if shorter)
    - Use PostgreSQL ILIKE for case-insensitive search across title AND content:
      ```typescript
      await prisma.kbArticle.findMany({
        where: {
          isPublished: true,
          OR: [
            { title: { contains: q, mode: 'insensitive' } },
            { content: { contains: q, mode: 'insensitive' } },
          ],
        },
        select: { id: true, title: true, slug: true, category: true, viewCount: true },
        take: 20,
      });
      ```
    - Return: `{ results: [...articles], query: q, total }`
    - If q is empty or < 2 chars: return 400 `{ error: 'Search query must be at least 2 characters' }`
  </action>
  <verify>
    1. `npx tsx prisma/seed-kb.ts` — runs without errors, 7 articles created
    2. GET /api/kb/articles → returns array of 7 articles (no content field in list response)
    3. GET /api/kb/articles?category=CREATIVE_FINANCE → returns 2 articles (subject-to + seller financing)
    4. GET /api/kb/articles/deal-analysis-70-percent-rule → returns full article with content markdown
    5. GET /api/kb/search?q=MAO → returns at least 1 result (70% rule article mentions MAO)
    6. GET /api/kb/search?q=subject-to → returns subject-to article
    7. GET /api/kb/search?q=x → 400 error (too short)
    8. `npm run build` TypeScript passes
  </verify>
  <done>
    - 7 starter articles seeded (ANALYSIS, COMPLIANCE, FORMULAS, CREATIVE_FINANCE categories)
    - GET /api/kb/articles returns published articles with optional category filter
    - GET /api/kb/articles/:slug returns full article with view count logging
    - GET /api/kb/search performs case-insensitive keyword search across title and content
    - View counts increment on authenticated article access (tracked for analytics)
  </done>
</task>

<task type="auto">
  <name>Task 2: Knowledge base UI — index page, article reader, and contextual help</name>
  <files>
    src/app/(dashboard)/kb/page.tsx
    src/app/(dashboard)/kb/[slug]/page.tsx
  </files>
  <action>
    Install react-markdown for rendering KB article markdown content:
    `npm install react-markdown`

    **1. Create `src/app/(dashboard)/kb/page.tsx`:**
    Client component.

    Layout:
    - Page title: "Knowledge Base"
    - Search bar at top: text input with magnifying glass icon, debounced 300ms, calls GET /api/kb/search?q=...
    - Category filter tabs: "All" | "Analysis" | "Formulas" | "Creative Finance" | "Compliance"
    - Article grid (2 cols on desktop, 1 col mobile): each card shows:
      - Category badge (colored by category: CREATIVE_FINANCE=purple, FORMULAS=blue, ANALYSIS=teal, COMPLIANCE=orange)
      - Article title (bold)
      - View count (small gray text)
      - "Read article →" link to /kb/:slug
    - Empty state: "No articles found for [search term]"
    - Initial load: fetch GET /api/kb/articles (all published)
    - On search: fetch GET /api/kb/search?q=term
    - On category tab click: fetch GET /api/kb/articles?category=CATEGORY

    **2. Create `src/app/(dashboard)/kb/[slug]/page.tsx`:**
    Client component.

    Layout:
    - "← Back to Knowledge Base" link
    - Article title (h1)
    - Category badge + view count
    - Divider
    - Article content rendered with `<ReactMarkdown>` from react-markdown
      - Prose styling via Tailwind (add prose class or manual heading/paragraph styles)
    - At bottom: "Related articles" section — static links to 2-3 other articles from same category (fetch GET /api/kb/articles?category=CURRENT_CATEGORY, filter out current)

    **Contextual help integration for deal detail page** (KB-04):
    These are shallow links — no new component needed, just navigation links added to the deal detail page (plan 06 already created that page, but if it's not yet complete, add the links here).

    Add a "Learning Resources" section to deal detail page OR export a helper:
    ```typescript
    // src/lib/kb/contextualLinks.ts
    export const CONTEXTUAL_KB_LINKS: Record<string, { title: string; slug: string }[]> = {
      'deal-detail': [
        { title: 'How to Calculate MAO (70% Rule)', slug: 'deal-analysis-70-percent-rule' },
        { title: 'Reading Property Distress Signals', slug: 'reading-distress-signals' },
      ],
      'pipeline': [
        { title: 'Understanding Pipeline Stages', slug: 'deal-pipeline-stages' },
      ],
      'import': [
        { title: 'Quick Start Guide', slug: 'platform-quick-start' },
      ],
    };
    ```

    Add a small "Need help?" callout to the deal detail page (or the pipeline page) that shows 2 relevant KB article links. This satisfies KB-04 (context-aware help).

    If src/app/(dashboard)/deals/[id]/page.tsx was created in plan 06: add a "Resources" section at the bottom linking to contextual KB articles. If plan 06 hasn't run yet, add this KB integration to the deal detail page as part of this plan.
  </action>
  <verify>
    1. Navigate to http://localhost:3000/kb — see article grid with category badges
    2. Click "Creative Finance" tab — see only 2 creative finance articles
    3. Type "MAO" in search bar — see 70% rule article appear
    4. Click on 70% rule article — opens /kb/deal-analysis-70-percent-rule with full markdown rendered
    5. Headings, bullet points, code blocks render correctly in article reader
    6. "Related articles" section at bottom shows other FORMULAS/ANALYSIS articles
    7. Navigate to /pipeline — "Need help?" section shows "Understanding Pipeline Stages" link
    8. Navigate to /deals/:id — "Resources" section shows MAO and distress signals KB links
    9. `npm run build` — zero TypeScript errors
  </verify>
  <done>
    - KB index at /kb shows all articles with search and category filter (KB-01, KB-03)
    - Article reader at /kb/:slug renders full markdown content (KB-01)
    - Creative finance articles (subject-to, seller financing) accessible at /kb/[slug] (KB-02)
    - Search returns relevant articles for keyword queries (KB-03)
    - Deal detail and pipeline pages include contextual KB article links (KB-04)
  </done>
</task>

</tasks>

<verification>
1. Seed articles: `npx tsx prisma/seed-kb.ts` → 7 articles in DB
2. Browse KB: /kb → articles visible in grid
3. Filter by CREATIVE_FINANCE → subject-to + seller financing articles
4. Search "TCPA" → TCPA compliance article returned
5. Read article → full markdown content rendered with proper formatting
6. Deal detail page → "Resources" section with 2 KB links
7. KB links open correct articles
8. View counts: read article twice → viewCount increments
</verification>

<success_criteria>
- Knowledge base accessible at /kb with 7+ seeded articles (KB-01)
- Creative finance guides (subject-to, seller financing) readable in full (KB-02)
- Keyword search returns relevant articles for terms like "MAO", "subject-to", "TCPA" (KB-03)
- Deal detail page and pipeline page include contextual KB article links (KB-04)
- Article markdown renders with proper headings, bullets, and formatting
- View count tracked per article per authenticated user
</success_criteria>

<output>
After completion, create `.planning/phases/01-core-deal-sourcing-crm/01-07-SUMMARY.md`
</output>
