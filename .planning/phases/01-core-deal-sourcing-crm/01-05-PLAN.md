---
phase: 01-core-deal-sourcing-crm
plan: "05"
type: execute
wave: 2
depends_on:
  - "01-01"
files_modified:
  - src/lib/compliance/encryption.ts
  - src/lib/compliance/tcpaValidator.ts
  - src/app/api/compliance/contacts/route.ts
  - src/app/api/compliance/consent/route.ts
  - src/app/api/compliance/opt-out/route.ts
  - src/app/api/compliance/audit/route.ts
  - src/app/api/compliance/dnc-check/route.ts

autonomous: true
requirements:
  - TC-03
  - TC-04
  - TC-05
  - TC-06

must_haves:
  truths:
    - "System logs every contact attempt with timestamp, method, consent status, and user ID"
    - "User must confirm consent was obtained before a contact attempt is logged"
    - "System checks the Do Not Call list before allowing a contact to be logged — DNC numbers are flagged"
    - "System flags any contact attempt where consent_status is NO_CONSENT_OBTAINED as a TCPA violation"
    - "User can view the full audit trail of all contact attempts (read-only)"
    - "Consumer opt-outs are recorded with timestamp and the system flags them on the DNC list immediately"
    - "Phone numbers are never stored or returned in plain text — always encrypted"
  artifacts:
    - path: "src/lib/compliance/encryption.ts"
      provides: "AES-256-GCM phone number encryption/decryption using ENCRYPTION_KEY env var"
      exports: ["encryptPhone", "decryptPhone", "hashPhoneForLookup"]
    - path: "src/lib/compliance/tcpaValidator.ts"
      provides: "TCPA validation: DNC check, consent validation, violation detection"
      exports: ["checkDncList", "validateContactAttempt", "TcpaViolationError"]
    - path: "src/app/api/compliance/contacts/route.ts"
      provides: "POST /api/compliance/contacts — log a contact attempt with consent verification"
      exports: ["POST"]
    - path: "src/app/api/compliance/consent/route.ts"
      provides: "POST /api/compliance/consent — record written consent from property owner"
      exports: ["POST"]
    - path: "src/app/api/compliance/opt-out/route.ts"
      provides: "POST /api/compliance/opt-out — process consumer opt-out, add to DNC list"
      exports: ["POST"]
    - path: "src/app/api/compliance/audit/route.ts"
      provides: "GET /api/compliance/audit — read-only contact log for audit trail (TC-05)"
      exports: ["GET"]
    - path: "src/app/api/compliance/dnc-check/route.ts"
      provides: "POST /api/compliance/dnc-check — real-time DNC list check before contact"
      exports: ["POST"]
  key_links:
    - from: "src/app/api/compliance/contacts/route.ts"
      to: "src/lib/compliance/tcpaValidator.ts"
      via: "calls validateContactAttempt() which checks DNC list and consent before logging"
      pattern: "validateContactAttempt"
    - from: "src/lib/compliance/tcpaValidator.ts"
      to: "prisma.doNotCallEntry"
      via: "hashes phone number and queries DNC list before any contact is logged"
      pattern: "prisma\\.doNotCallEntry\\.findFirst"
    - from: "src/lib/compliance/encryption.ts"
      to: "ENCRYPTION_KEY"
      via: "AES-256-GCM encryption using 32-byte key from environment"
      pattern: "ENCRYPTION_KEY"

user_setup:
  - service: encryption-key
    why: "Phone number encryption for TCPA compliance (NEVER store phones in plain text)"
    env_vars:
      - name: ENCRYPTION_KEY
        source: "Generate with: node -e \"console.log(require('crypto').randomBytes(32).toString('hex'))\""
    dashboard_config: []
---

<objective>
Implement the TCPA compliance infrastructure: phone number encryption, Do Not Call list enforcement, contact attempt logging with mandatory consent verification, opt-out processing, and read-only audit trail.

Purpose: TCPA violations cost $500–$1,500 per contact. This is a P0 legal requirement — not optional. Every contact attempt must be logged with consent status. DNC numbers must be blocked before contact. This plan builds the compliance layer that protects the user from liability before any outreach is possible in Phase 2.

Output: Working compliance API endpoints that: verify DNC status in real time, require consent confirmation before logging contact, record opt-outs immediately, and expose read-only audit trail. Phone numbers are encrypted at the application layer (AES-256-GCM) before any persistence.
</objective>

<execution_context>
@/Users/jakezebe/.claude/get-shit-done/workflows/execute-plan.md
@/Users/jakezebe/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-core-deal-sourcing-crm/01-RESEARCH.md
@.planning/phases/01-core-deal-sourcing-crm/01-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Phone encryption utilities and TCPA validator</name>
  <files>
    src/lib/compliance/encryption.ts
    src/lib/compliance/tcpaValidator.ts
  </files>
  <action>
    **CRITICAL SECURITY REQUIREMENT:** Phone numbers must NEVER be stored in plain text. Use AES-256-GCM at the application layer before any DB write. DNC lookups use a one-way HMAC hash (not encrypted value) for real-time lookup without decryption.

    **1. Create `src/lib/compliance/encryption.ts`:**
    ```typescript
    import crypto from 'crypto';

    const ENCRYPTION_KEY = Buffer.from(process.env.ENCRYPTION_KEY!, 'hex'); // 32 bytes
    const HMAC_KEY = Buffer.from(process.env.ENCRYPTION_KEY!, 'hex'); // Same key, different use

    if (!process.env.ENCRYPTION_KEY || process.env.ENCRYPTION_KEY.length !== 64) {
      throw new Error('ENCRYPTION_KEY must be a 64-char hex string (32 bytes). Generate with: node -e "console.log(require(\'crypto\').randomBytes(32).toString(\'hex\'))"');
    }

    // Encrypt phone number for storage — returns base64-encoded JSON: { iv, authTag, ciphertext }
    export function encryptPhone(phone: string): string {
      const normalized = phone.replace(/\D/g, ''); // Strip non-digits for normalization
      const iv = crypto.randomBytes(12); // 96-bit IV for GCM
      const cipher = crypto.createCipheriv('aes-256-gcm', ENCRYPTION_KEY, iv);
      const encrypted = Buffer.concat([cipher.update(normalized, 'utf8'), cipher.final()]);
      const authTag = cipher.getAuthTag();
      return Buffer.from(JSON.stringify({
        iv: iv.toString('hex'),
        authTag: authTag.toString('hex'),
        ciphertext: encrypted.toString('hex'),
      })).toString('base64');
    }

    // Decrypt for display (use sparingly — only for audit exports with proper authorization)
    export function decryptPhone(encryptedPhone: string): string {
      const { iv, authTag, ciphertext } = JSON.parse(
        Buffer.from(encryptedPhone, 'base64').toString('utf8')
      );
      const decipher = crypto.createDecipheriv('aes-256-gcm', ENCRYPTION_KEY, Buffer.from(iv, 'hex'));
      decipher.setAuthTag(Buffer.from(authTag, 'hex'));
      return decipher.update(Buffer.from(ciphertext, 'hex')) + decipher.final('utf8');
    }

    // One-way HMAC-SHA256 hash for DNC list lookups (consistent across calls, not reversible)
    export function hashPhoneForLookup(phone: string): string {
      const normalized = phone.replace(/\D/g, '');
      return crypto.createHmac('sha256', HMAC_KEY).update(normalized).digest('hex');
    }
    ```

    **2. Create `src/lib/compliance/tcpaValidator.ts`:**
    ```typescript
    import { prisma } from '@/lib/db';
    import { ConsentStatus, ContactMethod } from '@prisma/client';
    import { encryptPhone, hashPhoneForLookup } from './encryption';

    export class TcpaViolationError extends Error {
      constructor(
        message: string,
        public readonly violationType: 'DNC_LIST' | 'NO_CONSENT' | 'OPT_OUT_PENDING'
      ) {
        super(message);
        this.name = 'TcpaViolationError';
      }
    }

    export interface ContactAttemptInput {
      propertyId: string;
      phoneNumber: string;           // Plain text — will be encrypted before storage
      contactMethod: ContactMethod;
      consentStatus: ConsentStatus;
      consentTimestamp?: Date;       // When user obtained written consent
      consentMedium?: string;        // HOW consent was obtained (FORM, EMAIL_REPLY, etc.)
      consentDetails?: Record<string, unknown>; // Which disclosures were checked
      notes?: string;
      userId: string;
    }

    // Real-time DNC list check — throws TcpaViolationError if phone is on DNC list
    export async function checkDncList(phoneNumber: string): Promise<void> {
      const hash = hashPhoneForLookup(phoneNumber);
      const dncEntry = await prisma.doNotCallEntry.findFirst({
        where: {
          phoneEncrypted: hash, // Stored as HMAC hash, not encrypted value
          OR: [
            { expiryDate: null },
            { expiryDate: { gt: new Date() } },
          ],
        },
      });
      if (dncEntry) {
        throw new TcpaViolationError(
          'This phone number is on the Do Not Call list. Contact is not permitted.',
          'DNC_LIST'
        );
      }
    }

    // Validate contact attempt: check DNC, verify consent status, log to DB
    // Returns the created ContactLog record
    export async function validateContactAttempt(input: ContactAttemptInput) {
      const { phoneNumber, consentStatus, propertyId, userId, ...rest } = input;

      // STEP 1: Always check DNC list before any contact
      await checkDncList(phoneNumber); // Throws TcpaViolationError if on DNC

      // STEP 2: Flag as violation if no consent (log it, but mark violation)
      // Per TCPA: must log the attempt even if no consent, for audit trail
      const isViolation = consentStatus === 'NO_CONSENT_OBTAINED';

      // STEP 3: Encrypt phone before storage
      const encryptedPhone = encryptPhone(phoneNumber);

      // STEP 4: Write to contact_logs (APPEND-ONLY — no update, no delete)
      const log = await prisma.contactLog.create({
        data: {
          propertyId,
          userId,
          ownerPhoneEncrypted: encryptedPhone,
          contactTimestamp: new Date(),
          contactMethod: input.contactMethod,
          consentStatus,
          consentTimestamp: input.consentTimestamp,
          consentMedium: input.consentMedium,
          consentDetails: input.consentDetails ?? {},
          notes: input.notes,
          // createdAt is immutable — set by DB default
        },
      });

      // STEP 5: If no consent, still throw violation error AFTER logging
      if (isViolation) {
        throw new TcpaViolationError(
          'Contact logged with NO_CONSENT_OBTAINED status. This is a TCPA violation risk.',
          'NO_CONSENT'
        );
      }

      return log;
    }
    ```

    Note: `DoNotCallEntry.phoneEncrypted` stores the HMAC hash (not the AES-encrypted value) for efficient real-time lookup. Add a note comment in the schema and here to clarify this design decision. Update the Prisma schema comment if needed — the field name is misleading but the design is intentional.
  </action>
  <verify>
    1. `npx tsc --noEmit` passes on src/lib/compliance/ files
    2. encryptPhone('555-123-4567') returns different base64 string each call (different IV)
    3. decryptPhone(encryptPhone('5551234567')) === '5551234567' (round-trip)
    4. hashPhoneForLookup('555-123-4567') === hashPhoneForLookup('5551234567') (normalization)
    5. hashPhoneForLookup('5551234567') always returns same value (deterministic HMAC)
    6. checkDncList with a non-DNC number resolves without throwing
    7. checkDncList with a DNC-listed hash throws TcpaViolationError with violationType 'DNC_LIST'
  </verify>
  <done>
    - encryptPhone() uses AES-256-GCM with random IV — different ciphertext each call
    - decryptPhone() correctly reverses encryptPhone() (round-trip verified)
    - hashPhoneForLookup() normalizes digits and returns consistent HMAC-SHA256 hash
    - checkDncList() throws TcpaViolationError for DNC-listed numbers
    - validateContactAttempt() logs to ContactLog even when consent is missing (for audit), then throws violation error
    - All functions throw descriptive errors for missing ENCRYPTION_KEY
  </done>
</task>

<task type="auto">
  <name>Task 2: TCPA compliance API endpoints (contact log, consent, opt-out, audit, DNC check)</name>
  <files>
    src/app/api/compliance/contacts/route.ts
    src/app/api/compliance/consent/route.ts
    src/app/api/compliance/opt-out/route.ts
    src/app/api/compliance/audit/route.ts
    src/app/api/compliance/dnc-check/route.ts
  </files>
  <action>
    All endpoints require Clerk authentication. User scoping: contacts are always associated with the authenticated user.

    **1. Create `src/app/api/compliance/contacts/route.ts`:**
    POST /api/compliance/contacts — log a contact attempt:
    - Body (validated with Zod):
      ```typescript
      const ContactSchema = z.object({
        propertyId: z.string().uuid(),
        phoneNumber: z.string().min(10).max(20),
        contactMethod: z.enum(['EMAIL', 'CALL', 'SMS', 'LETTER']),
        consentStatus: z.enum(['NO_CONSENT_OBTAINED', 'EXPRESS_WRITTEN_CONSENT', 'PRIOR_EXPRESS_CONSENT', 'DO_NOT_CALL']),
        consentTimestamp: z.string().datetime().optional(),
        consentMedium: z.string().optional(),
        consentDetails: z.record(z.unknown()).optional(),
        notes: z.string().max(1000).optional(),
      });
      ```
    - Call `validateContactAttempt()` from tcpaValidator.ts
    - On TcpaViolationError with type 'DNC_LIST': return 403 with `{ error: 'DNC_LIST_BLOCKED', message }` — do NOT log (DNC block prevents logging)
    - On TcpaViolationError with type 'NO_CONSENT': return 200 with logged contact + `{ violation: true, violationType: 'NO_CONSENT' }` — logged for audit but flagged
    - On success: return 201 with contact log entry (no phone number in response — NEVER return encrypted or plain phone)

    **2. Create `src/app/api/compliance/consent/route.ts`:**
    POST /api/compliance/consent — record written consent obtained from property owner:
    - Body:
      ```typescript
      const ConsentSchema = z.object({
        phoneNumber: z.string().min(10).max(20),
        consentMethod: z.string(),            // FORM_SUBMISSION, EMAIL_REPLY, SMS_REPLY, IN_PERSON
        disclosuresAcknowledged: z.array(z.string()),  // List of disclosure texts shown
        notes: z.string().optional(),
      });
      ```
    - Encrypt phone with encryptPhone() for storage in ConsentRecord
    - Store HMAC hash in a separate indexed lookup field (add `phoneHash String` to ConsentRecord if needed via migration)
    - Calculate `mustRetainUntil` as new Date() + 4 years (TCPA 4-year retention requirement per RESEARCH.md)
    - Return 201 with consent record ID (no phone in response)

    **3. Create `src/app/api/compliance/opt-out/route.ts`:**
    POST /api/compliance/opt-out — process consumer opt-out request:
    - Body: `{ phoneNumber: string, optOutMethod: string, notes?: string }`
    - Validate phone number format
    - Add to DoNotCallEntry table using HMAC hash as phoneEncrypted field (for consistent lookup)
    - Set expiryDate to null (permanent until explicitly removed)
    - Update any existing ConsentRecord for this phone to set revocationTimestamp = now()
    - Return 200 with `{ processed: true, effectiveDate: now() }`
    - This must happen IMMEDIATELY — no delay per FCC 10-business-day rule (they must be honored, not queued)

    **4. Create `src/app/api/compliance/audit/route.ts`:**
    GET /api/compliance/audit — read-only audit trail:
    - Query params: `page`, `limit` (max 100), `startDate`, `endDate`, `contactMethod`, `consentStatus`
    - Returns ContactLog records for authenticated user
    - NEVER include ownerPhoneEncrypted in response
    - Include: id, contactTimestamp, contactMethod, consentStatus, propertyId, property.address, notes, createdAt
    - Add pagination: `{ logs, total, page, hasMore }`
    - This endpoint satisfies TC-05: user can view audit trail of all contact actions

    **5. Create `src/app/api/compliance/dnc-check/route.ts`:**
    POST /api/compliance/dnc-check — real-time DNC check before contact:
    - Body: `{ phoneNumber: string }`
    - Call `checkDncList(phoneNumber)`
    - Return `{ onDncList: boolean }` — 200 in both cases (check succeeded)
    - On DNC: `{ onDncList: true, message: 'This number is on the Do Not Call list' }`
    - Not on DNC: `{ onDncList: false }`
    - This enables the UI to warn users BEFORE they attempt to contact (TC-06: flag TCPA violations)
  </action>
  <verify>
    1. POST /api/compliance/dnc-check { phoneNumber: "5551234567" } (not on list) → { onDncList: false }
    2. POST /api/compliance/opt-out { phoneNumber: "5551234567" } → 200, { processed: true }
    3. POST /api/compliance/dnc-check { phoneNumber: "5551234567" } (now on list) → { onDncList: true }
    4. POST /api/compliance/contacts with DNC number → 403 { error: 'DNC_LIST_BLOCKED' }
    5. POST /api/compliance/contacts with NO_CONSENT_OBTAINED → 200 with { violation: true }
    6. POST /api/compliance/contacts with EXPRESS_WRITTEN_CONSENT → 201, no violation
    7. GET /api/compliance/audit → returns list of contact logs, no phone numbers in response
    8. POST /api/compliance/consent → 201, records consent with mustRetainUntil 4 years from now
  </verify>
  <done>
    - POST /api/compliance/contacts logs contact attempts with consent status — DNC numbers blocked (TC-03, TC-04)
    - NO_CONSENT_OBTAINED contacts are logged AND flagged as violations in response (TC-06)
    - POST /api/compliance/opt-out immediately adds number to DNC list (permanent) (TC-04)
    - GET /api/compliance/audit returns paginated contact log with no PII (TC-05)
    - POST /api/compliance/dnc-check enables pre-contact DNC verification (TC-06)
    - Zero phone numbers returned in plain text from any endpoint
  </done>
</task>

</tasks>

<verification>
1. Full opt-out flow: POST /opt-out → POST /dnc-check → confirm { onDncList: true }
2. Contact attempt on DNC number → 403 DNC_LIST_BLOCKED (contact is NOT logged)
3. Contact attempt with no consent → 200 with violation: true (contact IS logged for audit)
4. Contact attempt with EXPRESS_WRITTEN_CONSENT → 201 success
5. Audit trail: GET /api/compliance/audit → all logged contacts visible, no phone numbers
6. Consent record: POST /api/compliance/consent → mustRetainUntil is ~4 years from now
7. Encryption: query DB directly — ownerPhoneEncrypted in ContactLog is base64 JSON (not plain text)
8. DNC check response time: under 100ms (single index lookup)
</verification>

<success_criteria>
- Phone numbers are stored as AES-256-GCM encrypted strings — plain text never in DB or API responses
- DNC list check runs before any contact attempt — DNC numbers get 403 response
- Contact attempts without consent are logged AND flagged as TCPA violations (not silently ignored)
- Consumer opt-outs are immediately added to DNC list (no queue delay)
- Audit trail endpoint returns full contact history without exposing PII (TC-05)
- ContactLog and ConsentRecord tables are append-only — no UPDATE or DELETE operations
</success_criteria>

<output>
After completion, create `.planning/phases/01-core-deal-sourcing-crm/01-05-SUMMARY.md`
</output>
