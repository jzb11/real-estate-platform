---
phase: 01-core-deal-sourcing-crm
plan: "06"
type: execute
wave: 3
depends_on:
  - "01-02"
  - "01-03"
  - "01-04"
files_modified:
  - src/app/(dashboard)/dashboard/page.tsx
  - src/app/(dashboard)/pipeline/page.tsx
  - src/app/(dashboard)/pipeline/DealCard.tsx
  - src/app/(dashboard)/pipeline/PipelineColumn.tsx
  - src/app/(dashboard)/deals/[id]/page.tsx
  - src/app/(dashboard)/import/page.tsx
  - src/components/ui/DataFreshnessAlert.tsx
  - src/app/(dashboard)/properties/page.tsx

autonomous: false
requirements:
  - DS-07
  - QA-03
  - QA-04
  - QA-05
  - TC-01
  - TC-02

must_haves:
  truths:
    - "User can see a Kanban pipeline board with columns: SOURCED, ANALYZING, QUALIFIED, UNDER_CONTRACT, CLOSED"
    - "User can click any deal card to see full property details, financials, and stage history"
    - "User can move a deal to the next pipeline stage using a button (not drag-drop — simple is correct for MVP)"
    - "Property detail view shows calculated MAO (Maximum Allowable Offer = ARV × 0.70 − repair costs)"
    - "Only QUALIFIED deals appear when user filters to 'Qualified only' view"
    - "Data freshness date is displayed for every property — stale data (>14 days) shows a warning"
    - "User can upload a PropStream CSV file and see import results (rows imported, updated, skipped)"
  artifacts:
    - path: "src/app/(dashboard)/pipeline/page.tsx"
      provides: "Kanban pipeline board — fetches GET /api/deals, renders 5 stage columns"
      min_lines: 60
    - path: "src/app/(dashboard)/pipeline/DealCard.tsx"
      provides: "Deal card component showing address, score, profit estimate, advance-stage button"
      min_lines: 40
    - path: "src/app/(dashboard)/deals/[id]/page.tsx"
      provides: "Deal detail page with property financials, MAO calculation, stage history"
      min_lines: 80
    - path: "src/app/(dashboard)/import/page.tsx"
      provides: "CSV import page with file upload, progress feedback, import results"
      min_lines: 50
    - path: "src/components/ui/DataFreshnessAlert.tsx"
      provides: "Reusable alert component showing data age and stale warning"
      min_lines: 20
  key_links:
    - from: "src/app/(dashboard)/pipeline/page.tsx"
      to: "/api/deals"
      via: "fetch('/api/deals') on mount, re-fetches after stage transitions"
      pattern: "fetch.*api/deals"
    - from: "src/app/(dashboard)/pipeline/DealCard.tsx"
      to: "/api/deals/[id]/transition"
      via: "Advance Stage button POSTs to /api/deals/:id/transition"
      pattern: "fetch.*transition"
    - from: "src/app/(dashboard)/deals/[id]/page.tsx"
      to: "/api/deals/[id]"
      via: "fetch('/api/deals/:id') for full deal detail with history"
      pattern: "fetch.*api/deals.*id"
---

<objective>
Implement the core frontend UI: Kanban pipeline board, deal detail page with property financials and MAO calculation, CSV import page, and property list with search filters.

Purpose: Plans 01-02 through 01-04 built the data layer. This plan makes it user-accessible. The pipeline board (TC-01) and stage tracking (TC-02) become tangible. The deal detail view (QA-04) shows calculated offer price (QA-05) and filters to qualified deals (QA-03). Data freshness alerts meet the RESEARCH.md requirement to always show when data was last updated.

Output: A working dashboard where the user can import deals from CSV, see them in a Kanban pipeline, click into deal details, see the calculated MAO, and move deals through stages.
</objective>

<execution_context>
@/Users/jakezebe/.claude/get-shit-done/workflows/execute-plan.md
@/Users/jakezebe/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-core-deal-sourcing-crm/01-RESEARCH.md
@.planning/phases/01-core-deal-sourcing-crm/01-01-SUMMARY.md
@.planning/phases/01-core-deal-sourcing-crm/01-04-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Kanban pipeline board and deal cards</name>
  <files>
    src/app/(dashboard)/pipeline/page.tsx
    src/app/(dashboard)/pipeline/DealCard.tsx
    src/app/(dashboard)/pipeline/PipelineColumn.tsx
    src/components/ui/DataFreshnessAlert.tsx
    src/app/(dashboard)/dashboard/page.tsx
  </files>
  <action>
    Use Tailwind CSS for all styling. No additional UI library needed — keep it simple and maintainable.

    **1. Create `src/components/ui/DataFreshnessAlert.tsx`:**
    Reusable component that takes `dataFreshnessDate: Date | string` and shows:
    - If < 7 days old: nothing (or small green "Fresh" badge)
    - If 7-14 days old: yellow warning "Data is X days old"
    - If > 14 days old: orange alert "Data is stale (X days old) — verify before making offer"
    Use Tailwind color classes (yellow-50 border-yellow-400 text-yellow-800 / orange-50 border-orange-400).

    **2. Create `src/app/(dashboard)/pipeline/DealCard.tsx`:**
    Props: `{ deal: DealWithPipeline, onTransition: (dealId: string, targetState: string) => void }`

    Display per card (compact, card style with shadow and border):
    - Property address (bold) + city, state
    - Deal status badge (color-coded: SOURCED=gray, ANALYZING=blue, QUALIFIED=green, REJECTED=red, UNDER_CONTRACT=yellow, CLOSED=emerald)
    - Qualification score (show as "Score: 72/100" — only if > 0)
    - DataFreshnessAlert component (inline, compact)
    - "Advance" button showing NEXT valid stage: e.g., if SOURCED → shows "Move to Analyzing"
    - Link to deal detail page

    Get next valid state from a helper:
    ```typescript
    const NEXT_STAGE: Partial<Record<DealStatus, DealStatus>> = {
      SOURCED: 'ANALYZING',
      ANALYZING: 'QUALIFIED',
      QUALIFIED: 'UNDER_CONTRACT',
      UNDER_CONTRACT: 'CLOSED',
    };
    ```
    Show "No further stages" for REJECTED and CLOSED.

    The "Advance" button calls `onTransition(deal.id, nextStage)` — parent handles the API call and re-fetch.

    **3. Create `src/app/(dashboard)/pipeline/PipelineColumn.tsx`:**
    Props: `{ stage: DealStatus, deals: DealWithPipeline[], onTransition: fn }`
    Renders: Stage header with count badge + scrollable list of DealCard components.
    Column header colors matching DealCard badge colors.
    Minimum height: 200px (shows empty state "No deals in this stage").

    **4. Create `src/app/(dashboard)/pipeline/page.tsx`:**
    - Server Component that fetches `/api/deals` on render (use Next.js fetch with `cache: 'no-store'`)
    - OR use client component with `useEffect` + useState for the transition optimistic updates
    - Recommendation: use client component (easier for optimistic updates after stage transitions)
    - Layout: horizontal scroll on mobile, 5-column grid on desktop (grid-cols-1 sm:grid-cols-2 lg:grid-cols-5)
    - Show "Qualified Only" toggle button that switches between full pipeline and QUALIFIED-only flat list
    - After transition: re-fetch deals (invalidate and refetch, not full page reload)
    - Transition handler:
      ```typescript
      async function handleTransition(dealId: string, targetState: string) {
        const res = await fetch(`/api/deals/${dealId}/transition`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ targetState }),
        });
        if (!res.ok) {
          const err = await res.json();
          alert(err.error); // Simple alert for MVP — no toast library needed
          return;
        }
        await fetchDeals(); // Re-fetch to update board
      }
      ```

    **5. Update `src/app/(dashboard)/dashboard/page.tsx`:**
    Replace placeholder with real dashboard home:
    - Welcome message with user's name from `useUser()`
    - Quick stats row: total deals, qualified deals, under contract
    - Quick action buttons: "Import CSV" → /import, "View Pipeline" → /pipeline
    - Recent activity: last 5 DealHistory entries across all user's deals
  </action>
  <verify>
    1. `npm run dev` — navigate to /pipeline, see 5 column headers (SOURCED, ANALYZING, QUALIFIED, UNDER_CONTRACT, CLOSED)
    2. With test data: deals appear in correct columns
    3. Click "Move to Analyzing" on a SOURCED deal — deal moves to ANALYZING column (after re-fetch)
    4. DataFreshnessAlert shows orange warning for property with dataFreshnessDate > 14 days ago
    5. "Qualified Only" toggle shows only QUALIFIED deals in flat list
    6. `npm run build` — zero TypeScript errors
  </verify>
  <done>
    - Kanban pipeline board renders 5 stage columns with deal cards (TC-01)
    - Deal cards show address, score, data freshness warning
    - "Advance Stage" button triggers state transition and board re-fetches (TC-02)
    - "Qualified Only" filter shows only QUALIFIED deals (QA-03)
    - DataFreshnessAlert shows warning for data older than 14 days (per RESEARCH.md requirement)
  </done>
</task>

<task type="auto">
  <name>Task 2: Deal detail page, property financials, and CSV import UI</name>
  <files>
    src/app/(dashboard)/deals/[id]/page.tsx
    src/app/(dashboard)/import/page.tsx
    src/app/(dashboard)/properties/page.tsx
  </files>
  <action>
    **1. Create `src/app/(dashboard)/deals/[id]/page.tsx`:**
    Client component. Fetches GET /api/deals/:id on mount.

    Layout (single column, max-w-4xl):
    - Header: Property address (h1) + status badge + "Back to Pipeline" link
    - Section: Property Details
      - Address, city, state, zip
      - Property type
      - Estimated Value (ARV)
      - Last Sale Price + Date
      - Tax Assessed Value
      - Distress Signals (render as colored badges: foreclosure=red, preforeclosure=orange, auction=red, etc.)
      - DataFreshnessAlert (data age warning)

    - Section: Deal Analysis (QA-04, QA-05)
      - Qualification Score: big number (0-100) with color (< 50 = orange, >= 50 = green)
      - MAO Calculator display:
        ```
        ARV: $200,000
        Repair Estimate: [editable input, default $0]
        ────────────────────────
        MAO = (ARV × 70%) − Repairs
        MAO = ($140,000) − $0 = $140,000
        ```
        The repair cost input is local state (not saved to DB). MAO recalculates as user types.
      - Rule Evaluation Breakdown: table of rules that passed/failed with scores awarded

    - Section: Stage History (TC-02)
      - Timeline list: each DealHistory entry showing fieldChanged, oldValue → newValue, timestamp
      - Most recent first

    - Section: Actions
      - "Advance to [next stage]" button (calls /api/deals/:id/transition)
      - "Add Note" button (opens inline textarea, saves via PATCH /api/deals/:id)

    **2. Create `src/app/(dashboard)/import/page.tsx`:**
    Client component for PropStream CSV import.

    Layout:
    - Page title: "Import Properties from PropStream"
    - Instructions text: "Export your property list from PropStream as CSV, then upload below."
    - File upload area (styled dropzone using HTML input[type=file] with onDragOver/onDrop handlers — no external library)
    - On file select: show filename + file size
    - "Import" button: POST to /api/properties/import with FormData
    - Progress state: "Uploading..." → "Importing..." (show spinner)
    - Results display:
      ```
      Import Complete
      ✓ 847 properties imported
      ↺ 23 properties updated (already existed)
      — 5 rows skipped (missing required fields)
      ✗ 2 errors (see details)
      ```
    - If errors: show expandable error details

    **3. Create `src/app/(dashboard)/properties/page.tsx`:**
    Property list with search filters (DS-07: user receives list with key metrics).

    Layout:
    - Filter bar at top: Days on Market (min/max inputs), Equity % (min input), Max Debt, Max Rate
    - "Load Saved Filter" dropdown (fetches GET /api/search-filters, populates inputs)
    - "Save Current Filter" button (POSTs to /api/search-filters)
    - Results table with columns: Address, City/State, Est. Value, Equity %, Debt Owed, Days Listed, Data Age, Actions
    - "Create Deal" button per property row (POSTs to /api/deals { propertyId, title: address })
    - Data freshness: show "X days ago" in Data Age column, red if > 14 days
    - Pagination: "Load More" button (page-based, not cursor)

    All fetch calls must include credentials (Clerk auth cookie) — Next.js handles this automatically for same-origin API routes.
  </action>
  <verify>
    1. Navigate to /deals/:id — see property details, ARV, distress signals, qualification score
    2. Change repair cost input — MAO recalculates in real time (no API call)
    3. Click "Advance Stage" on deal detail → transitions and updates badge
    4. Stage history section shows timeline of all transitions
    5. Navigate to /import — upload a sample PropStream CSV → see import results (imported/updated/skipped counts)
    6. Navigate to /properties — filter by minEquity=30 → only matching properties shown
    7. Save a filter, reload page, load saved filter → inputs populate correctly
    8. Click "Create Deal" on a property row → deal created, success message shown
    9. `npm run build` — zero TypeScript errors
  </verify>
  <done>
    - Deal detail page shows ARV, distress signals, qualification score, rule breakdown (QA-04)
    - MAO calculator (ARV × 0.70 − repairs) updates in real time from user-entered repair cost (QA-05)
    - Stage history timeline shows all transitions with timestamps (TC-02)
    - CSV import page accepts PropStream export, shows import summary (DS-07 UI)
    - Property list shows key metrics with data freshness date (DS-07)
    - Saved filters can be loaded from dropdown (DS-06 UI)
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
    Full frontend UI: Kanban pipeline board, deal detail page with MAO calculator, CSV import page, and property list with filter controls. All connected to live API endpoints from plans 01-02, 01-03, 01-04.
  </what-built>
  <how-to-verify>
    1. Start the dev server: `npm run dev`
    2. Sign in at http://localhost:3000 (use test account created in plan 01-01)
    3. Visit http://localhost:3000/import — upload a PropStream CSV (or use sample from /prisma/seed.ts)
    4. Confirm import results show: "X properties imported"
    5. Visit http://localhost:3000/properties — confirm properties appear in table with equity %, debt, days listed
    6. Click "Create Deal" on one property — confirm success message
    7. Visit http://localhost:3000/pipeline — confirm deal appears in SOURCED column
    8. Click "Move to Analyzing" on the deal card — confirm deal moves to ANALYZING column
    9. Click the deal card to open deal detail at /deals/:id
    10. Confirm: property address, estimated value, qualification score visible
    11. Enter a repair cost (e.g., $30,000) — confirm MAO updates: (ARV × 0.70) − $30,000
    12. Check stage history section shows SOURCED → ANALYZING transition with timestamp
    13. Click "Qualified Only" toggle on pipeline — only QUALIFIED deals shown (none if none qualified yet)
    14. Data freshness: if any properties have stale data (> 14 days), confirm orange alert appears
  </how-to-verify>
  <resume-signal>Type "approved" if all steps work, or describe which step failed and what you saw</resume-signal>
</task>

</tasks>

<verification>
1. Pipeline board loads with correct stage columns
2. Deal transitions work and board updates after each transition
3. Deal detail shows full property financials + MAO calculation
4. MAO recalculates in real time when repair cost is changed
5. CSV import accepts file and returns row counts
6. Property list filters work (equity, debt, days, rate)
7. Saved filters persist across page reload
8. DataFreshnessAlert appears for properties with stale data
9. `npm run build` — zero TypeScript errors
</verification>

<success_criteria>
- Kanban pipeline board visible at /pipeline with 5 stage columns (TC-01)
- Stage transitions work from pipeline board and deal detail page (TC-02)
- Deal detail shows property financials, qualification score, and rule breakdown (QA-04)
- MAO calculator computes (ARV × 0.70) − repair costs and updates in real time (QA-05)
- "Qualified Only" filter on pipeline shows only QUALIFIED deals (QA-03)
- CSV import page accepts PropStream export and shows import summary (DS-07)
- Data freshness date visible on all property displays; stale warning for > 14 days
</success_criteria>

<output>
After completion, create `.planning/phases/01-core-deal-sourcing-crm/01-06-SUMMARY.md`
</output>
