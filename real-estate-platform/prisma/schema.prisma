generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

enum DealStatus {
  SOURCED
  ANALYZING
  QUALIFIED
  REJECTED
  UNDER_CONTRACT
  CLOSED
}

enum ContactMethod {
  EMAIL
  CALL
  SMS
  LETTER
}

enum ConsentStatus {
  NO_CONSENT_OBTAINED
  EXPRESS_WRITTEN_CONSENT
  PRIOR_EXPRESS_CONSENT
  DO_NOT_CALL
}

enum RuleType {
  FILTER
  SCORE_COMPONENT
}

enum Operator {
  GT
  LT
  EQ
  IN
  CONTAINS
  RANGE
  NOT_CONTAINS
}

enum KbCategory {
  ANALYSIS
  COMPLIANCE
  FORMULAS
  MARKET_TRENDS
  CREATIVE_FINANCE
}

model User {
  id        String    @id @default(uuid())
  clerkId   String    @unique
  email     String    @unique
  name      String?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  deals              Deal[]
  qualificationRules QualificationRule[]
  contactLogs        ContactLog[]
  kbAccessLogs       KbAccessLog[]
  dealHistories      DealHistory[]
  savedSearchFilters SavedSearchFilter[]
  offeredDeals       OfferedDeal[]
  followUpSequences  FollowUpSequence[]
  followUpScheduled  FollowUpScheduled[]
}

model Property {
  id               String    @id @default(uuid())
  externalId       String    @unique
  address          String
  city             String
  state            String
  zip              String
  latitude         Float?
  longitude        Float?
  propertyType     String?
  estimatedValue   Float?
  lastSalePrice    Float?
  lastSaleDate     DateTime?
  taxAssessedValue Float?
  ownershipName    String?
  ownershipPhone   String? // encrypted at app layer (AES-256-GCM)
  equityPercent    Float? // Equity percentage 0-100 — typed column for efficient filtering
  debtOwed         Float? // Total open liens in dollars
  interestRate     Float? // Current mortgage interest rate
  daysOnMarket     Int? // Days property has been listed
  distressSignals  Json      @default("{}")
  dataSource       String    @default("CSV")
  dataFreshnessDate DateTime
  rawData          Json      @default("{}")
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  deals       Deal[]
  contactLogs ContactLog[]

  @@index([address, city, state])
  @@index([dataFreshnessDate])
  @@index([externalId])
  @@index([equityPercent])
  @@index([debtOwed])
  @@index([daysOnMarket])
}

model Deal {
  id                 String     @id @default(uuid())
  propertyId         String
  userId             String
  title              String
  status             DealStatus @default(SOURCED)
  stageHistory       Json       @default("[]")
  customFields       Json       @default("{}")
  qualificationScore Int        @default(0)
  estimatedProfit    Float?
  notes              String?
  pipelinePosition   Int        @default(0)
  closedDate         DateTime?
  createdAt          DateTime   @default(now())
  updatedAt          DateTime   @updatedAt

  property  Property            @relation(fields: [propertyId], references: [id])
  user      User                @relation(fields: [userId], references: [id])
  history   DealHistory[]
  ruleEvals RuleEvaluationLog[]
  offeredDeals      OfferedDeal[]
  followUpScheduled FollowUpScheduled[]

  @@index([userId, status])
  @@index([userId, pipelinePosition])
}

model DealHistory {
  id           String   @id @default(uuid())
  dealId       String
  userId       String
  fieldChanged String
  oldValue     String?
  newValue     String?
  createdAt    DateTime @default(now()) // IMMUTABLE — no updatedAt

  deal Deal @relation(fields: [dealId], references: [id])
  user User @relation(fields: [userId], references: [id])

  @@index([dealId, createdAt])
}

model ContactLog {
  id                  String        @id @default(uuid())
  propertyId          String
  userId              String
  ownerPhoneEncrypted String?
  contactTimestamp    DateTime
  contactMethod       ContactMethod
  consentStatus       ConsentStatus
  consentTimestamp    DateTime?
  consentMedium       String?
  consentDetails      Json          @default("{}")
  optOutRequestedAt   DateTime?
  optOutProcessedAt   DateTime?
  callRecordingUrl    String?
  notes               String?
  createdAt           DateTime      @default(now()) // IMMUTABLE — no updatedAt

  property Property @relation(fields: [propertyId], references: [id])
  user     User     @relation(fields: [userId], references: [id])

  @@index([propertyId])
  @@index([userId, contactTimestamp])
}

model ConsentRecord {
  id                      String    @id @default(uuid())
  ownerPhoneEncrypted     String    // AES-256-GCM ciphertext (reversible, for display)
  phoneHash               String    // HMAC-SHA256 hash (one-way, for fast lookup without decryption)
  originalConsentTimestamp DateTime
  originalConsentMethod   String
  disclosuresAcknowledged Json      @default("[]")
  revocationTimestamp     DateTime?
  revocationMethod        String?
  revocationProcessedDate DateTime?
  complianceStatus        String    @default("COMPLIANT")
  mustRetainUntil         DateTime
  createdAt               DateTime  @default(now())
  updatedAt               DateTime  @updatedAt

  @@index([ownerPhoneEncrypted])
  @@index([phoneHash]) // Fast opt-out processing: find consent records by phone hash
}

model DoNotCallEntry {
  id             String    @id @default(uuid())
  phoneEncrypted String    @unique
  addedReason    String
  expiryDate     DateTime?
  createdAt      DateTime  @default(now())

  @@index([phoneEncrypted])
}

model QualificationRule {
  id          String   @id @default(uuid())
  userId      String? // null = system default rule
  name        String
  description String?
  ruleType    RuleType
  fieldName   String
  operator    Operator
  value       Json
  weight      Int      @default(0)
  enabled     Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  user        User?               @relation(fields: [userId], references: [id])
  evaluations RuleEvaluationLog[]

  @@index([userId, enabled])
}

model RuleEvaluationLog {
  id               String   @id @default(uuid())
  dealId           String
  ruleId           String
  evaluationResult String
  scoreAwarded     Int      @default(0)
  evaluatedAt      DateTime @default(now())

  deal Deal              @relation(fields: [dealId], references: [id])
  rule QualificationRule @relation(fields: [ruleId], references: [id])

  @@index([dealId])
}

model KbArticle {
  id          String     @id @default(uuid())
  title       String
  slug        String     @unique
  category    KbCategory
  content     String
  isPublished Boolean    @default(false)
  viewCount   Int        @default(0)
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt

  accessLogs KbAccessLog[]

  @@index([slug])
  @@index([category])
  @@index([isPublished])
}

model KbAccessLog {
  id        String   @id @default(uuid())
  articleId String
  userId    String
  viewedAt  DateTime @default(now())

  article KbArticle @relation(fields: [articleId], references: [id])
  user    User      @relation(fields: [userId], references: [id])
}

model SavedSearchFilter {
  id        String   @id @default(uuid())
  userId    String
  name      String
  filters   Json
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id])

  @@index([userId])
}

enum SendgridEventType {
  DELIVERED
  OPEN
  CLICK
  BOUNCE
  COMPLAINT
  UNSUBSCRIBE
  GROUP_UNSUBSCRIBE
}

enum OfferedDealStatus {
  DRAFT
  SENT
  OPENED
  CLICKED
  BOUNCED
  COMPLAINED
  UNSUBSCRIBED
}

model OfferedDeal {
  id                String            @id @default(uuid())
  dealId            String
  userId            String
  sentToEmail       String
  recipientName     String?
  status            OfferedDealStatus @default(SENT)
  sentAt            DateTime
  emailOpenedAt     DateTime?
  linkClickedAt     DateTime?
  bouncedAt         DateTime?
  complainedAt      DateTime?
  bouncetype        String?
  complaintType     String?
  sendgridMessageId String?
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt

  deal Deal @relation(fields: [dealId], references: [id], onDelete: Cascade)
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, sentAt])
  @@index([dealId])
  @@index([status])
}

model SendgridWebhook {
  id            String            @id @default(uuid())
  eventType     SendgridEventType
  email         String
  timestamp     DateTime
  messageId     String?
  bounceType    String?
  complaintType String?
  url           String?
  rawPayload    Json
  processedAt   DateTime          @default(now())

  @@index([messageId])
  @@index([email, timestamp])
  @@index([eventType])
}

model FollowUpSequence {
  id          String   @id @default(uuid())
  userId      String
  name        String
  description String?
  steps       Json
  enabled     Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  user               User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  scheduledSequences FollowUpScheduled[]
  followUpEvents     FollowUpEvent[]

  @@index([userId, enabled])
}

model FollowUpScheduled {
  id          String   @id @default(uuid())
  dealId      String
  userId      String
  sequenceId  String
  currentStep Int      @default(0)
  nextStepAt  DateTime
  status      String   @default("ACTIVE")
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  deal     Deal             @relation(fields: [dealId], references: [id], onDelete: Cascade)
  user     User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  sequence FollowUpSequence @relation(fields: [sequenceId], references: [id], onDelete: Cascade)
  events   FollowUpEvent[]

  @@index([userId, dealId])
  @@index([nextStepAt, status])
}

model FollowUpEvent {
  id            String   @id @default(uuid())
  scheduledId   String
  sequenceId    String
  stepIndex     Int
  eventType     String
  content       Json?
  status        String
  failureReason String?
  sentAt        DateTime
  createdAt     DateTime @default(now())

  scheduled FollowUpScheduled @relation(fields: [scheduledId], references: [id], onDelete: Cascade)
  sequence  FollowUpSequence  @relation(fields: [sequenceId], references: [id], onDelete: Cascade)

  @@index([scheduledId, createdAt])
  @@index([eventType])
}
